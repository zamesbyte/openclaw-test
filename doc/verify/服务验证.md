# OpenClaw 服务验证手册

> 本文档记录服务验证的步骤、预期结果和实际验证记录。

---

## 一、验证清单

| # | 验证项 | 命令 | 预期结果 | 状态 |
|---|--------|------|----------|------|
| 1 | CLI 安装 | `openclaw --version` | 输出版本号 | ✅ 通过 (2026.2.12) |
| 2 | Doctor 检查 | `openclaw doctor --non-interactive` | 无 CRITICAL 错误 | ✅ 通过 |
| 3 | 网关启动 | `openclaw gateway status` | running + reachable | ✅ 通过 (pid 11763) |
| 4 | 模型配置 | `openclaw models status` | 显示 dashscope/qwen-plus | ✅ 通过 |
| 5 | 模型通信 | `openclaw agent --local --session-id test ...` | 正常返回文本 | ✅ 通过 ("我能正常工作！") |
| 6 | Discord 通道 | `openclaw status --deep` | Discord: ok | ✅ 通过 (@openclaw-discard) |
| 7 | UI Assets | 访问 http://127.0.0.1:18789/ | 页面可访问 | ✅ 通过 |
| 8 | 目录权限 | `ls -la ~/.openclaw` | 权限 700 | ✅ 通过 |
| 9 | 插件加载 | `openclaw plugins list` | Errors: 0 | ✅ 通过 (5 loaded, 0 errors) |
| 10 | 完整状态 | `openclaw status` | 所有组件正常 | ✅ 通过 |

---

## 二、详细验证命令

### 2.1 基础安装验证

```bash
# 验证 CLI 安装
openclaw --version
# 预期: 2026.2.12

# 验证命令位置
which openclaw
# 预期: /Users/zhanlifeng/Library/pnpm/openclaw
```

### 2.2 健康检查

```bash
# 综合健康检查
openclaw doctor --non-interactive

# 关注项:
# - UI assets: 应存在（无 "missing" 提示）
# - Gateway: running
# - Plugins: Errors: 0
# - State integrity: 无 CRITICAL
```

### 2.3 网关服务验证

```bash
# 查看网关状态
openclaw gateway status
# 预期: Runtime: running, RPC probe: ok, Listening: 127.0.0.1:18789

# 查看完整状态
openclaw status
# 预期: Gateway running, Discord OK, Sessions table 显示
```

### 2.4 模型验证

```bash
# 查看模型配置
openclaw models status
# 预期: Default: dashscope/qwen-plus, Auth 有效

# 测试模型通信
openclaw agent --local --session-id verify-test --message "你好，回复OK" --json
# 预期: payloads[0].text 有文本返回, model 为 qwen-plus
```

### 2.5 通道验证

```bash
# 查看通道状态
openclaw channels status
# 预期: Discord default: enabled, configured, running

# 深度通道探测
openclaw status --deep
```

### 2.6 安全审计

```bash
# 基础安全审计
openclaw security audit

# 深度审计
openclaw security audit --deep
```

---

## 三、验证记录

### 3.1 初始验证 (2026-02-14 上午)

**环境信息:**
- macOS darwin 26.3 (arm64)
- Node.js v22.22.0 (via nvm)
- pnpm 10.29.3
- OpenClaw v2026.2.12 (源码安装, tag v2026.2.12)

**验证结果:**
- **所有 10 项验证全部通过**
- 网关正常运行在 127.0.0.1:18789
- Discord Bot @MyOpenClaw 在线
- 模型 dashscope/qwen-plus 通信正常，响应延迟 ~1.5s
- 5 个插件已加载，0 错误

**已知提示（非阻塞）:**
1. **nvm 路径警告**: 服务使用 nvm 管理的 Node，升级 nvm Node 版本后需要重新安装服务。不影响当前使用。
2. **Discord DM pairing**: Discord DM 默认需要配对码授权，这是安全机制，正常行为。
3. **Skills missing requirements**: 46 个 skill 因缺少额外依赖未加载（如 Python 包等），按需安装即可。

### 3.2 通道首次接入 (2026-02-14 晚 第一轮)

**变更内容:**
1. Discord DM 策略由 `pairing` 改为 `allowlist`，添加用户 ID `1251896437047033892`
2. 启用飞书 (Feishu) 插件
3. 网关重启 (新 PID: 34032)

**验证结果:**

| # | 验证项 | 命令 | 结果 | 状态 |
|---|--------|------|------|------|
| 1 | 网关重启后连通性 | `openclaw status --deep` | reachable 19ms | ✅ 通过 |
| 2 | Discord 深度探测 | `openclaw status --deep` | ok (@MyOpenClaw:default:1122ms) | ✅ 通过 |
| 3 | Discord DM allowlist | `openclaw config get channels.discord` | allowFrom: ["1251896437047033892"] | ✅ 通过 |
| 4 | Agent 响应 | `openclaw agent --agent main --message "测试"` | HEARTBEAT_OK | ✅ 通过 |
| 5 | 飞书插件启用 | `openclaw plugins list` | feishu: disabled → enabled | ✅ 通过 |
| 6 | 飞书通道状态 | `openclaw status --deep` | ON / SETUP (待配置凭证) | ⏳ 进行中 |

### 3.3 双通道完整配置 (2026-02-14 晚 第二轮)

**变更内容:**
1. 创建新 Discord 机器人 `openclaw-discard` (Application ID: `1472255888621310093`)
2. 更新 Discord Bot Token (新 Token: `MTQ3...M83c`)
3. 配置飞书 App ID (`cli_a91a26d46278dcbd`) 和 App Secret
4. 网关重启 (新 PID: 35685)

**验证结果:**

| # | 验证项 | 命令/方式 | 结果 | 状态 |
|---|--------|-----------|------|------|
| 1 | 网关重启后连通性 | `openclaw status --deep` | reachable 39ms | ✅ 通过 |
| 2 | Discord 深度探测 | `openclaw status --deep` | ok (@openclaw-discard:default:1124ms) | ✅ 通过 |
| 3 | Discord 登录确认 | 网关日志 | `logged in to discord as 1472255888621310093` | ✅ 通过 |
| 4 | Discord 用户解析 | 网关日志 | `discord users resolved: 1251896437047033892→1251896437047033892` | ✅ 通过 |
| 5 | 飞书通道状态 | `openclaw status --deep` | ok (default:default:ok) | ✅ 通过 |
| 6 | 飞书 WebSocket | 网关日志 | `feishu[default]: WebSocket client started` → `ws client ready` | ✅ 通过 |
| 7 | 飞书工具注册 | 网关日志 | feishu_doc, feishu_wiki, feishu_drive, feishu_bitable (6 tools) | ✅ 通过 |
| 8 | Agent 模型通信 | `openclaw agent --agent main --message "..."` | 回复 "OK"，延迟 ~1.6s | ✅ 通过 |

**当前完整通道配置:**
```json
{
  "channels": {
    "discord": {
      "enabled": true,
      "token": "MTQ3...M83c",
      "groupPolicy": "allowlist",
      "dm": {
        "policy": "allowlist",
        "allowFrom": ["1251896437047033892"]
      }
    },
    "feishu": {
      "appId": "cli_a91a26d46278dcbd",
      "appSecret": "psPh...FYlH"
    }
  },
  "plugins": {
    "entries": {
      "discord": { "enabled": true },
      "feishu": { "enabled": true }
    }
  }
}
```

**Discord 邀请链接:**
```
https://discord.com/oauth2/authorize?client_id=1472255888621310093&scope=bot%20applications.commands&permissions=2147601472
```

**飞书开放平台待完成项:**

以下步骤需在飞书开放平台 (https://open.feishu.cn/app/cli_a91a26d46278dcbd) 手动完成:

- [ ] 启用机器人能力 (应用能力 > 机器人)
- [ ] 配置权限 (权限管理 > 批量导入 JSON，参见 `doc/ref/feishu-bot-setup-guide.md`)
- [ ] 配置事件订阅 (事件与回调 > 使用长连接接收事件 > 添加 `im.message.receive_v1`)
- [ ] 创建版本并发布应用 (版本管理与发布)

**Discord 使用说明:**
1. 打开上方邀请链接，选择服务器，授权机器人加入
2. 在 Discord 中私信 @openclaw-discard 即可开始对话
3. 机器人会使用 qwen-plus 模型回复

**飞书使用说明 (完成上方待完成项后):**
1. 在飞书中搜索 "openclaw-feishu" 机器人
2. 私聊发送消息，首次会收到配对码
3. 运行 `openclaw pairing approve feishu <配对码>` 批准配对
4. 配对后即可正常对话

---

## 四、故障排查快捷命令

```bash
# 网关无法启动
openclaw logs --follow       # 查看实时日志
openclaw doctor --fix        # 自动修复

# 模型不响应
openclaw models status       # 检查模型配置和认证
openclaw health              # 网关健康检查

# Discord 连接失败
openclaw channels status     # 检查通道状态
openclaw channels logs       # 查看通道日志

# 飞书连接失败
openclaw logs --follow       # 查看飞书 WebSocket 日志
openclaw config get channels.feishu  # 确认配置

# 飞书配对管理
openclaw pairing list feishu          # 查看待配对请求
openclaw pairing approve feishu <CODE>  # 批准配对

# 深度状态检测（所有通道）
openclaw status --deep       # 含连通性探测

# 重置并重启
openclaw gateway restart     # 重启网关
```
