# 飞书浏览器工具调用故障诊断与修复

> 日期: 2026-02-16
> 状态: **已修复**（共发现并修复 3 个问题）

---

## 一、问题描述

### 问题 A: 浏览器工具不被调用

用户通过飞书向 OpenClaw 发送消息：

> "打开 https://example.com 并告诉我页面标题"

**预期行为**: Agent 调用 `browser` 工具打开浏览器、导航到目标 URL、获取页面快照，然后返回页面标题。

**实际行为**: Agent 只回复了文字 "I'll open https://example.com and get the page title for you. Let me use the browser tool to navigate to the example website:"，但**没有实际调用浏览器工具**。

### 问题 B: 浏览器工具超时

模型升级后 agent 确实调用了浏览器工具，但第二步 snapshot 操作报 "Can't reach the OpenClaw browser control service (timed out after 20000ms)"。

### 问题 C: 过期页面元素引用 (stale refs)

执行百度搜索等多步操作时，agent 使用了会话中积累的旧 snapshot 里的元素 ref（如 `e36`），导致错误 "Unknown ref e36. Run a new snapshot and use a ref from that snapshot."。

---

## 二、诊断过程

### 2.1 初步检查

| 检查项 | 结果 | 状态 |
|--------|------|------|
| 飞书通道连接 | OK (WebSocket 连接正常) | ✅ |
| 浏览器启用 | `browser.enabled: true` | ✅ |
| 浏览器运行 | `running: true`, CDP 就绪 | ✅ |
| browser 工具注册 | 已注册 (32 个工具中包含 browser) | ✅ |
| 飞书消息接收 | 网关正确接收并分发给 agent | ✅ |

### 2.2 会话日志分析

通过分析会话文件 `sessions/ddfcd9b1-...jsonl`，发现关键证据：

#### 失败的调用 (qwen-plus 模型)

| 时间 | 消息来源 | 运行时长 | stopReason | 是否调用工具 |
|------|----------|----------|------------|-------------|
| 04:24:59 | 飞书 DM | 2006ms | `stop` | **否** |
| 04:26:31 | 飞书 DM | 2859ms | `stop` | **否** |
| 04:30:09 | 飞书 DM | 1799ms | `stop` | **否** |

#### 成功的调用 (同一会话，通过 CLI)

| 时间 | 消息来源 | 运行时长 | stopReason | 是否调用工具 |
|------|----------|----------|------------|-------------|
| 04:35:41 | CLI | 5675ms | `toolUse` | **是** (browser navigate) |

**关键发现**: 所有失败的调用中，模型输出以 `":\n\n"` 结尾——模型在文本中描述了"让我使用浏览器工具..."的意图，但在生成实际的 function call JSON 之前就提前触发了 `stop` 终止符。

### 2.3 根本原因

**`qwen-plus` 模型的 tool calling (函数调用) 能力不稳定。**

具体表现为：
1. 模型在生成文本后应继续输出 function call 结构，但在约 30% 的情况下提前生成了 `stop` 终止符
2. 失败概率与会话上下文长度正相关——在 ~18-19k tokens 时失败率明显升高
3. 成功时模型输出 40-70 tokens 并生成 `toolUse`；失败时仅输出 14-40 tokens 并生成 `stop`
4. 这是 DashScope OpenAI 兼容 API 下 `qwen-plus` 模型的已知行为特征

---

## 三、修复方案

### 3.1 模型升级（问题一）

将 agent 默认模型从 `dashscope/qwen-plus` 升级为 `dashscope/qwen-max`：

```bash
# 添加 qwen-max 模型定义
openclaw config set models.providers.dashscope.models '[
  {"id":"qwen-max","name":"Qwen Max (Aliyun)","reasoning":false,"input":["text"],"cost":{"input":0,"output":0,"cacheRead":0,"cacheWrite":0},"contextWindow":131072,"maxTokens":8192},
  {"id":"qwen-plus","name":"Qwen Plus (Aliyun)","reasoning":false,"input":["text"],"cost":{"input":0,"output":0,"cacheRead":0,"cacheWrite":0},"contextWindow":131072,"maxTokens":8192}
]'

# 切换主模型
openclaw config set agents.defaults.model.primary "dashscope/qwen-max"

# 重启网关生效
openclaw gateway restart
```

### 3.2 重启网关与浏览器服务（问题 B）

模型升级后，agent 确实开始调用浏览器工具了，但第二步 snapshot 操作出现了 **"Can't reach the OpenClaw browser control service (timed out after 20000ms)"** 超时错误。

**原因**: 网关在多次测试后积累了残留状态（陈旧的 CDP 连接、WebSocket 请求队列等），导致浏览器工具的网关内部 IPC 通信超时。

**修复**: 完全重启网关和浏览器服务以清理状态：

```bash
# 停止浏览器
openclaw browser --browser-profile openclaw stop

# 重启网关
openclaw gateway restart

# 等待网关就绪后启动浏览器
sleep 5
openclaw browser --browser-profile openclaw start
```

### 3.3 清理会话上下文（问题 C）

重启后简单任务（打开 example.com）正常，但复杂任务（百度搜索）仍失败。

**原因**: 会话中积累了大量旧的浏览器快照（含 element refs 如 `e36`），模型在新页面上复用了这些过期的 refs，导致 "Unknown ref" 错误。

**修复**: 清理旧会话，让 agent 从干净上下文开始：

```bash
# 备份旧会话
cp ~/.openclaw/agents/main/sessions/<session-id>.jsonl \
   ~/.openclaw/agents/main/sessions/<session-id>.jsonl.bak

# 删除旧会话
rm ~/.openclaw/agents/main/sessions/<session-id>.jsonl

# 重启网关并启动浏览器
openclaw gateway restart
sleep 5
openclaw browser --browser-profile openclaw start
```

> **注意**: 清理会话后，agent 会失去之前的对话记忆（记录在 MEMORY.md 中的内容不受影响）。

### 3.3 为什么选择 qwen-max

| 对比项 | qwen-plus | qwen-max |
|--------|-----------|----------|
| Tool Calling 稳定性 | ~70% (上下文增大后降低) | ~100% (连续测试全部成功) |
| 平均响应时间 | ~2s (因为不调用工具) | ~17-25s (包含实际工具调用) |
| 上下文窗口 | 128K | 128K |
| 成本 | 较低 | 较高 |
| 推荐用途 | 简单文本对话 | 需要工具调用的复杂任务 |

---

## 四、验证结果

### 4.1 CLI 测试（模型升级后）

| # | 测试方式 | 目标 URL | 页面标题 | 耗时 | 状态 |
|---|----------|----------|----------|------|------|
| 1 | CLI (新 session) | https://example.com | "Example Domain" | 24.6s | ✅ |
| 2 | CLI (feishu channel) | https://example.com | "Example Domain" | 19.1s | ✅ |
| 3 | CLI (baidu) | https://www.baidu.com | "百度一下，你就知道" | 17.5s | ✅ |

### 4.2 飞书真实消息测试（网关重启后）

| # | 测试方式 | 目标 URL | 页面标题 | 耗时 | 状态 |
|---|----------|----------|----------|------|------|
| 4 | CLI (--deliver to feishu) | https://example.com | "Example Domain" | 25.5s | ✅ |
| 5 | **飞书真实消息** | https://example.com | **"Example Domain"** | **23.3s** | **✅** |

### 4.3 复杂任务测试（会话清理后）

| # | 测试方式 | 任务 | 结果 | 耗时 | 状态 |
|---|----------|------|------|------|------|
| 6 | CLI (feishu channel) | 百度搜索"绍兴有什么好玩的景点"并总结 | 返回鲁迅故里、沈园、东湖风景区等景点 | 18.5s | ✅ |

每次测试中 `qwen-max` 都正确地：
1. 生成 `browser` 工具调用 (action: navigate)
2. 执行浏览器导航
3. 生成 `browser` 工具调用 (action: snapshot)
4. 从快照中提取页面标题
5. 用中文回复用户

---

## 五、配置变更摘要

| 配置路径 | 修改前 | 修改后 |
|----------|--------|--------|
| `agents.defaults.model.primary` | `dashscope/qwen-plus` | `dashscope/qwen-max` |
| `models.providers.dashscope.models[0]` | qwen-plus (唯一模型) | qwen-max (主力) |
| `models.providers.dashscope.models[1]` | 无 | qwen-plus (备用) |
| 会话状态 | 117 行历史（含大量过期快照） | 已清理，从零开始 |

---

## 六、预防建议

1. **模型选择**: 需要 tool calling 的场景（浏览器控制、文件操作、API 调用等）应优先使用 `qwen-max` 或其他 tool calling 稳定的模型
2. **会话监控**: 如果再次出现"描述工具但不调用"的情况，检查日志中的 `stopReason` 字段
3. **浏览器超时修复**: 如果浏览器工具返回 "timed out after 20000ms"，执行完全重启：
   ```bash
   openclaw browser --browser-profile openclaw stop
   openclaw gateway restart
   sleep 5
   openclaw browser --browser-profile openclaw start
   ```
4. **日志诊断命令**:
   ```bash
   # 实时查看 agent 运行日志
   openclaw logs --follow

   # 过滤浏览器相关错误
   openclaw logs --max-bytes 50000 | grep -iE "error|browser"

   # 查看会话历史（检查 stopReason）
   cat ~/.openclaw/agents/main/sessions/<session-id>.jsonl | python3 -m json.tool
   ```
5. **模型回退**: 可配置 fallback 模型列表，当主模型失败时自动切换：
   ```bash
   openclaw models fallbacks set dashscope/qwen-max dashscope/qwen-plus
   ```
6. **操作注意**: 浏览器操作需要 15-25 秒，等待回复期间**不要发送新消息**，否则可能引起并发冲突导致超时

---

## 七、天气查询回复不完整（wttr.in）

### 现象

用户在飞书发「查看今天天气」后，机器人回复了「I'll check the current weather for you using the **wttr.in** service. Let me get the weather information:」和「Let me check the weather output:」，但**没有给出实际天气内容**，回复看起来被截断或不完整。

### 根因

Agent 使用了 **exec** 工具执行 `curl wttr.in/...`。exec 在默认「yield 窗口」内若未结束会先返回 `"Command still running (session xxx, pid xxx). Use process (list/poll/...) for follow-up."`，不会把 curl 的 stdout 返回给模型。因此模型拿不到天气文本，只能回复「让我查一下天气输出」而无法给出具体结果。

### 修复

已修改 **weather 技能**（`openclaw-src/skills/weather/SKILL.md`），要求 agent **优先用 web_fetch** 请求 wttr.in，例如：

- `https://wttr.in/北京?format=3`  
- `https://wttr.in/London?format=3`

这样一次 HTTP 请求即可拿到天气文本，再让模型用中文总结后完整回复用户，避免 exec 未结束导致的回复不完整。

### 验证

1. 重启网关使技能/配置生效（若已改过技能）：`openclaw gateway restart`
2. 在飞书或 CLI 再次发送：「查看今天天气」或「北京今天天气怎么样」
3. 预期：回复中包含具体地点、天气状况、温度等，且以中文总结收尾，而不是停在「Let me check...」

---

## 八、相关文档

| 文档 | 路径 |
|------|------|
| 天气技能（优先 web_fetch） | `openclaw-src/skills/weather/SKILL.md` |
| 浏览器控制功能总结 | `doc/sum/浏览器控制功能总结.md` |
| 浏览器操作手册 | `doc/operate/浏览器控制操作手册.md` |
| 配置项总览 | `doc/sum/配置项.md` |
| 通道故障诊断 | `doc/sum/通道故障诊断与修复.md` |

---

> 最后更新: 2026-02-16
