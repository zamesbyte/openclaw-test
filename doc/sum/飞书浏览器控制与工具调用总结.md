# 飞书浏览器控制与工具调用总结

> 基于 `browser` 工具 + 飞书通道的实际踩坑与修复记录（已按当前代码实现和配置校正）。

---

## 一、功能概览

- 控制 Chrome/Chromium 托管浏览器（profile=`openclaw`）：
  - 启动/停止、打开 URL、列出/切换标签
  - DOM 快照（AI/ARIA 树）、截图、PDF 导出
  - 点击、输入、滚动、导航、上传等操作
- 通过 **Agent + 飞书** 用自然语言驱动浏览器：
  - 例：「打开 https://example.com 并告诉我页面标题」

默认配置（示例）：

```json5
{
  browser: {
    enabled: true,
    defaultProfile: "openclaw",
    executablePath: "/Applications/Google Chrome.app/Contents/MacOS/Google Chrome"
  }
}
```

---

## 二、命令行快速开始

```bash
# 1. 启动托管浏览器
openclaw browser --browser-profile openclaw start

# 2. 打开网页
openclaw browser --browser-profile openclaw open https://example.com

# 3. 快照 + 引用元素
openclaw browser --browser-profile openclaw snapshot

# 4. 根据 snapshot 中的 ref 点击元素
openclaw browser --browser-profile openclaw click e6
```

通过飞书使用（示例）：

- 「打开 https://example.com 并告诉我页面标题」
- 「在浏览器里搜索‘绍兴有什么好玩的景点’并总结一下」

> 注意：浏览器任务通常需要 15–25 秒，请在一次任务完成前**不要连发多条浏览器相关消息**，避免并发导致超时。

---

## 三、模型选择与 Tool Calling 稳定性

实测结论：

- `dashscope/qwen-plus` 在上下文较长时，常出现「只说要用浏览器，但不真正调用 tool」的问题：
  - 日志里 `stopReason: "stop"`，没有 `toolUse`；
  - 文本里会说「让我使用浏览器工具…」，但没有真正的函数调用。
- `dashscope/qwen-max` 在同样场景下 tool calling 稳定（连续多次均成功调用 browser）。

**当前实现**：

- 代码层面仍支持 `qwen-plus` 与 `qwen-max`；
- **推荐做法**：在需要大量浏览器控制的环境，把默认模型切到 `qwen-max`：

```bash
# 在 dashscope providers 下补充 qwen-max 定义（若尚未添加）
openclaw config set models.providers.dashscope.models '[
  {"id":"qwen-max","name":"Qwen Max (Aliyun)","reasoning":false,"input":["text"],"cost":{"input":0,"output":0,"cacheRead":0,"cacheWrite":0},"contextWindow":131072,"maxTokens":8192},
  {"id":"qwen-plus","name":"Qwen Plus (Aliyun)","reasoning":false,"input":["text"],"cost":{"input":0,"output":0,"cacheRead":0,"cacheWrite":0},"contextWindow":131072,"maxTokens":8192}
]'

# 将默认模型切到 qwen-max（可选）
openclaw config set agents.defaults.model.primary "dashscope/qwen-max"
openclaw gateway restart
```

若希望继续使用 `qwen-plus`，建议至少在浏览器相关 Agent 中单独指定 `model` 为 `qwen-max`。

---

## 四、常见故障与修复

### 4.1 飞书里只说“我要用浏览器”，但没真正点开网页

**现象**：

- 飞书消息类似：「打开 https://example.com 并告诉我页面标题」；
- 回复只停留在「我将打开浏览器并访问该页面……」，没有真正调用 browser 工具。

**根因**：所用模型（典型是 `qwen-plus`）在生成文本后提前输出了 `stop`，没有生成函数调用。

**修复建议**：

- 为浏览器任务切换到 `qwen-max`（见第三节）；
- 或在 Agent 配置中显式指定浏览器相关会话使用 `qwen-max`；
- 清理过长的历史会话（旧 snapshot 太多时，模型更容易提前 stop）。

### 4.2 “Can't reach browser control service (timed out after 20000ms)”

**现象**：browser 工具已经被调用，但 snapshot 或后续操作报 20s 超时。

**原因**：网关或浏览器服务内部状态脏（陈旧的 CDP 连接 / WebSocket 队列）。

**处理步骤**：

```bash
openclaw browser --browser-profile openclaw stop
openclaw gateway restart
sleep 5
openclaw browser --browser-profile openclaw start
```

### 4.3 “Unknown ref e36. Run a new snapshot...”

**现象**：长会话里多次 snapshot 后，模型引用了旧快照里的元素 ref（如 `e36`），在新页面上已失效。

**解决办法**：

- 让模型先重新执行一次 `snapshot`，再从最新 snapshot 里选择 ref；
- 对极度“脏”的会话，直接删除对应 `~/.openclaw/agents/main/sessions/<session-id>.jsonl`，从新会话开始。

---

## 五、天气查询回复不完整（wttr.in）关联问题

曾出现过「让我用 wttr.in 查天气」但最终没有返回具体天气的情况，根因是：

- Agent 使用 `exec` 工具执行 `curl wttr.in/...`；
- exec 在默认时间窗内若未结束，只返回「Command still running...」，没有把 stdout 返回给模型。

当前修复方案（已按代码实现）：

- **weather 技能** 已改为优先使用 `web_fetch` 访问 wttr.in：
  - 例如 `https://wttr.in/北京?format=3`；
- 模型拿到完整文本后，再用中文总结返回给用户。

---

## 六、排查命令速查

```bash
# 实时查看与浏览器相关的日志
openclaw logs --follow | grep -iE "browser|cdp|error"

# 查看当前浏览器 profile 状态
openclaw browser --browser-profile openclaw status

# 查看最近一次会话 transcript（检查是否有 toolUse）
cat ~/.openclaw/agents/main/sessions/<session-id>.jsonl | python3 -m json.tool | less
```

