# 飞书浏览器控制与工具调用总结

> 基于 `browser` 工具 + 飞书通道的实际踩坑与修复记录（已按当前代码实现和配置校正）。

**若出现「Agent 说已打开百度/浏览器但用户没看到页面」**：见 **§4.6**（defaultProfile + 扩展附加）、**§4.9**（按日志排查）、**§4.10**（总结与检查清单），可避免重复踩坑。

---

## 一、功能概览

- 控制 Chrome/Chromium 托管浏览器（profile=`openclaw`）：
  - 启动/停止、打开 URL、列出/切换标签
  - DOM 快照（AI/ARIA 树）、截图、PDF 导出
  - 点击、输入、滚动、导航、上传等操作
- 通过 **Agent + 飞书** 用自然语言驱动浏览器：
  - 例：「打开 https://example.com 并告诉我页面标题」

默认配置（示例）：

```json5
{
  browser: {
    enabled: true,
    defaultProfile: "openclaw",
    executablePath: "/Applications/Google Chrome.app/Contents/MacOS/Google Chrome"
  }
}
```

---

## 二、命令行快速开始

```bash
# 1. 启动托管浏览器
openclaw browser --browser-profile openclaw start

# 2. 打开网页
openclaw browser --browser-profile openclaw open https://example.com

# 3. 快照 + 引用元素
openclaw browser --browser-profile openclaw snapshot

# 4. 根据 snapshot 中的 ref 点击元素
openclaw browser --browser-profile openclaw click e6
```

通过飞书使用（示例）：

- 「打开 https://example.com 并告诉我页面标题」
- 「在浏览器里搜索‘绍兴有什么好玩的景点’并总结一下」

> 注意：浏览器任务通常需要 15–25 秒，请在一次任务完成前**不要连发多条浏览器相关消息**，避免并发导致超时。

---

## 三、模型选择与 Tool Calling 稳定性

实测结论：

- `dashscope/qwen-plus` 在上下文较长时，常出现「只说要用浏览器，但不真正调用 tool」的问题：
  - 日志里 `stopReason: "stop"`，没有 `toolUse`；
  - 文本里会说「让我使用浏览器工具…」，但没有真正的函数调用。
- `dashscope/qwen-max` 在同样场景下 tool calling 稳定（连续多次均成功调用 browser）。

**当前实现**：

- 代码层面仍支持 `qwen-plus` 与 `qwen-max`；
- **推荐做法**：在需要大量浏览器控制的环境，把默认模型切到 `qwen-max`：

```bash
# 在 dashscope providers 下补充 qwen-max 定义（若尚未添加）
openclaw config set models.providers.dashscope.models '[
  {"id":"qwen-max","name":"Qwen Max (Aliyun)","reasoning":false,"input":["text"],"cost":{"input":0,"output":0,"cacheRead":0,"cacheWrite":0},"contextWindow":131072,"maxTokens":8192},
  {"id":"qwen-plus","name":"Qwen Plus (Aliyun)","reasoning":false,"input":["text"],"cost":{"input":0,"output":0,"cacheRead":0,"cacheWrite":0},"contextWindow":131072,"maxTokens":8192}
]'

# 将默认模型切到 qwen-max（可选）
openclaw config set agents.defaults.model.primary "dashscope/qwen-max"
openclaw gateway restart
```

若希望继续使用 `qwen-plus`，建议至少在浏览器相关 Agent 中单独指定 `model` 为 `qwen-max`。

---

## 四、常见故障与修复

### 4.1 飞书里只说“我要用浏览器”，但没真正点开网页

**现象**：

- 飞书消息类似：「打开 https://example.com 并告诉我页面标题」；
- 回复只停留在「我将打开浏览器并访问该页面……」，没有真正调用 browser 工具。

**根因**：所用模型（典型是 `qwen-plus`）在生成文本后提前输出了 `stop`，没有生成函数调用。

**修复建议**：

- 为浏览器任务切换到 `qwen-max`（见第三节）；
- 或在 Agent 配置中显式指定浏览器相关会话使用 `qwen-max`；
- 清理过长的历史会话（旧 snapshot 太多时，模型更容易提前 stop）。

### 4.2 “Can't reach browser control service (timed out after 20000ms)”

**现象**：browser 工具已经被调用，但 snapshot 或后续操作报 20s 超时。

**原因**：网关或浏览器服务内部状态脏（陈旧的 CDP 连接 / WebSocket 队列）。

**处理步骤**：

```bash
openclaw browser --browser-profile openclaw stop
openclaw gateway restart
sleep 5
openclaw browser --browser-profile openclaw start
```

### 4.3 “Unknown ref e36. Run a new snapshot...”

**现象**：长会话里多次 snapshot 后，模型引用了旧快照里的元素 ref（如 `e36`），在新页面上已失效。

**解决办法**：

- 让模型先重新执行一次 `snapshot`，再从最新 snapshot 里选择 ref；
- 对极度“脏”的会话，直接删除对应 `~/.openclaw/agents/main/sessions/<session-id>.jsonl`，从新会话开始。

### 4.4 飞书里说“需要先启动 gateway”或 “openclaw command isn't available”

**现象**：用户让「用浏览器打开百度 / 搜索 xxx」，回复里出现「我需要先启动 OpenClaw gateway 才能使用浏览器」或「openclaw 命令在当前环境不可用」，然后才尝试用 browser 工具。

**根因**：模型误以为使用浏览器前要先执行 `openclaw gateway start` 等命令。在飞书（或其它 channel）场景下，**网关已在运行**（正是网关在跑 Agent），且 exec 环境里通常没有 `openclaw` 在 PATH，导致失败。

**已做修复**：

- 系统提示中已增加：当用户要求用浏览器时，**直接调用 browser 工具**（如 action=status → start → open/navigate），**不要执行 openclaw 或 gateway 命令**。
- 配置中建议显式设置 `browser.enabled: true`（默认即为 true，显式写出可避免被覆盖）。

**验证**：在飞书里再次发送「帮我用浏览器打开百度，搜索最近一周最火的 AI 新闻，整理成 md 发给我」，Agent 应直接调用 browser 工具而非先跑 openclaw。

### 4.5 飞书里显示“已打开百度 / Now let me search”但实际没有 md 结果

**现象**：用户要求「用浏览器打开百度，搜索 xxx，整理成 md 发给我」后，飞书只收到一句「Baidu homepage has been opened successfully. Now let me search...」，没有收到整理好的 markdown。

**根因**：  
1. 流式回复会按「文本块」把内容推到飞书。模型在完成所有工具调用前就输出了中间叙述（如“已打开百度，现在去搜索”），这段文字被当作一条回复立刻发到飞书，用户看到的是“半截”回复。  
2. 后续步骤（搜索、snapshot、整理 md）可能仍在跑，但若模型再次输出或 run 结束，才会再发一条；若 run 超时/出错或模型未再输出，用户就只看到第一条，误以为“没效果”。

**已做修复**：  
- 在系统提示中明确：当用户要求**交付结果**（如「整理成 md 发给我」「发给我」）时，**不要输出任何中间状态或叙述**；完成全部工具调用后再一次性输出最终结果。否则中间文字会作为回复先发到 channel，看起来像未完成。  
- 同时在「Tool Call Style」中强调：用户若要求“格式后发给我”，在拿到最终结果前不要 emit 任何文字，拿到后再输出一次。

**验证**：飞书里再次发同一条「帮我用浏览器打开百度，搜索：最近一周最火的 AI 新闻，整理成 md 格式发给我」。应要么在较长时间后收到一条包含完整 md 的回复，要么因超时/错误收到错误说明，而不再先收到“已打开百度，现在去搜索”这类半截回复。

### 4.6 飞书里 Agent 说“将在百度搜索”但实际没看到浏览器打开百度

**现象**：Control UI 或飞书里 Agent 回复「I'll search for "绍兴的特产" on Baidu」或类似话术，当前 Chrome 顶部也有「OpenClaw Browser Relay 已开始调试此浏览器」的提示，但用户没有看到任何标签页打开百度。

**根因**：未配置 `browser.defaultProfile` 时，默认使用 **openclaw** profile。该 profile 会**另起一个**由 OpenClaw 托管的 Chrome 窗口（独立进程），页面会在这个窗口里打开，可能被其它窗口挡住或在其它桌面，所以你在「当前」Chrome（例如开着 Control UI 的那一个）里看不到百度。而你当前看到的 Chrome 是由 **chrome** profile（扩展中继）控制的——只有把默认 profile 设为 **chrome**，Agent 才会在你已经附加了扩展的那个标签页里打开百度，你才能在同一窗口里看到。

**已做修复**：  
- 在 `~/.openclaw/openclaw.json` 的 `browser` 中增加 **`"defaultProfile": "chrome"`**，使 Agent 默认使用扩展中继，在**你已附加的标签页**里打开页面。  
- 系统提示中补充：默认使用 Chrome 扩展时，页面会在用户附加的标签页中打开；若报「无附加标签」，提示用户先在要控制的标签页上点击扩展图标（badge 显示 ON）再重试。

**使用前提**：  
- 在要「看到」百度的那台机器上，用 Chrome 打开你要被控制的那一个标签页（可以是 Control UI 或任意页），点击 **OpenClaw Browser Relay** 扩展图标，使 badge 显示 **ON**（已附加）。之后在飞书里发「搜索绍兴的特产」等指令，百度会在该标签页打开，你即可在当前窗口看到。

**验证**：在已附加扩展的标签页的前提下，在飞书或 Control UI 发「用浏览器打开百度，搜索绍兴的特产」；应看到**当前** Chrome 里该标签页跳转到百度并展示搜索结果。

### 4.7 Control UI Chat 只看到飞书消息、看不到 Agent 回复（「还是没有看到效果」）

**现象**：在 Control UI 的 Chat 里能看到「System: Feishu[default] DM from ou_xxx: 总结最近的10条新闻」等来自飞书的消息，但下面没有 Agent 的回复，像“没有效果”。

**原因**：  
- 飞书来的消息会作为「系统事件」投递到对应会话，所以 Chat 里能看到这条**入站**消息。  
- Agent 的回复则只通过**飞书通道**的 dispatcher 发回飞书（调用飞书发消息 API），**不会**再写回 Control UI 的 Chat 流。  
- 因此：**回复只会在飞书客户端里出现**，在 Control UI Chat 里不会出现同一条回复。

**建议**：  
1. **先到飞书里看**：打开飞书 App/网页，看和机器人的对话里是否有 Agent 的回复（可能稍晚几秒到十几秒）。  
2. 若**飞书里也没有回复**，再排查：  
   - 在终端执行 `openclaw logs --follow`，再在飞书发一条「总结最近的10条新闻」或「用浏览器打开百度」，看日志里是否有：  
     - `feishu[...]: deliver called`（说明有内容发往飞书）、  
     - `dispatch complete (replies=...)`、  
     - 或报错（如 browser 的 “no tab attached”、超时等）。  
   - 若出现 “no tab attached” 等：先在被控机器上给要控制的标签页点击扩展图标（badge ON），再重试。  
   - 若长时间无 `deliver called` 且无报错：可能是模型未调用工具或 run 未结束，可适当延长等待或换更稳的模型（见第三节）。

**验证**：在飞书里发一条简单指令（如「你好」或「总结最近3条新闻」），在飞书对话中应能看到 Agent 的回复；Control UI Chat 仍可能只显示入站消息、不显示该回复，属预期行为。

### 4.8 「没有打开浏览器、也没看到工具调用」的确认与验证（按截图话术）

**现象**：飞书里发了「打开浏览器,打开百度,搜索:绍兴最近的10条新闻」后，Agent 回复了“已对百度搜索结果做 snapshot”并给出 10 条新闻摘要，但用户端**既没看到浏览器窗口打开，也没看到任何工具调用**的提示。

**可能原因**：  
1. **模型未真正调用 browser 工具**：模型可能根据上下文“编”出了一段合理回复（幻觉），并未执行 open → 搜索 → snapshot。  
2. **工具调用了但浏览器在别处**：例如默认 profile 是 openclaw 时会在单独窗口打开，或 chrome 时未附加标签页导致失败，但模型用其它方式（如记忆/幻觉）补全了回复。  
3. **工具调用有发到飞书，但被忽略**：飞书 DM 会话会收到「工具摘要」消息（如 🌐 Browser: open · url ...），可能出现在长回复之前、容易被忽略。

**已做改动**：  
- 在 **browser 工具** 内部增加明确日志（subsystem `agents/browser-tool`）：每次执行都会记一条  
  `browser tool: action=... url=... profile=...`  
  便于用 `openclaw logs --follow`（或 grep `browser-tool` / `browser tool`）确认**是否真的调用了** browser。  
- 配置上已建议 `browser.defaultProfile: "chrome"`，并在系统提示中说明「在已附加的标签页中打开」。

**按截图话术的验证步骤（不绕过问题）**：  

1. **确认扩展与标签页**  
   - 在本机 Chrome 打开要受控的标签页（如 Control UI 或空白页），点击 **OpenClaw Browser Relay** 扩展图标，使 badge 为 **ON**。  

2. **开日志再发话术**  
   - 终端执行：`openclaw logs --follow`（或 `openclaw logs --follow | grep -E "browser tool|feishu|deliver"`）。  
   - 在飞书里发与截图一致的话术：  
     **「打开浏览器,打开百度,搜索:绍兴最近的10条新闻」**  

3. **根据日志判断**  
   - 若出现 **`agents/browser-tool`** 或 **`browser tool: action=open url=...`**：说明 **browser 工具已被调用**。此时若仍没看到浏览器窗口，多半是 profile 或标签页未附加（见 4.6）；可再确认 `~/.openclaw/openclaw.json` 中 `browser.defaultProfile` 为 `"chrome"` 且该标签页已附加。  
   - 若**没有**上述 browser-tool / browser tool 日志：说明**本次 run 未调用 browser 工具**（可能是模型未发 tool call，或调用了其它工具）。可多试一次或换更稳的模型（见第三节）；若多次仍无该日志，需从模型/提示/会话上下文排查。  

4. **飞书里看工具摘要**  
   - 若工具被调用且为 DM，飞书会在最终长回复前收到一条短消息（如「🌐 Browser: open · url https://...」）。注意是否在长回复上方有一条这类短消息。

**结论**：用「是否有 `[openclaw] browser tool:` 日志」可明确区分「没调用 browser」与「调用了但浏览器未在眼前」；再结合 4.6 的 defaultProfile + 标签页附加，即可按截图话术把「打开浏览器 + 百度 + 搜索绍兴新闻」走通并验证。

### 4.9 基于日志的深度排查：执行命令 + 看日志（「不要再让我验证」）

**做法**：由助手在同一流程内执行「开日志 → 执行会触发 browser 的命令 → 从日志里截取 browser 相关行」做根因分析，而不是只给用户建议。

**实际执行与日志路径**：

1. 日志文件：`openclaw logs` 会输出到当日文件，例如 `/tmp/openclaw/openclaw-YYYY-MM-DD.log`（或配置的 `OPENCLAW_LOG_PATH`）。
2. 执行会触发 browser 的请求：
   - **CLI**：`openclaw agent --agent main -m "用 browser 工具执行 action=open targetUrl=https://www.baidu.com，不要用 openclaw 窗口"`（强制用 chrome profile 打开百度）。
   - **飞书**：在飞书里发同一条或「打开浏览器,打开百度,搜索:绍兴最近的10条新闻」；请求在 **Gateway** 执行，日志写入上述同一日志文件。
3. 在日志中 grep 关键信息：
   ```bash
   grep -n -E "browser-tool|browser tool|profile|embedded run tool|error|Error|no tab" /tmp/openclaw/openclaw-*.log | tail -100
   ```

**从日志能得出的结论（本次实际排查）**：

- 出现 **`\"subsystem\":\"agents/browser-tool\"`** 且 **`browser tool: action=open url=... profile=chrome`**：说明 **browser 工具已被调用**，且使用的是 **chrome** profile。
- 紧接着出现 **`embedded run tool start: ... tool=browser`** 与 **`embedded run tool end: ... tool=browser`**，且无 500/Error：说明 **open 接口成功返回**（Gateway 的 `POST /tabs/open` 已成功）。
- 因此「没有看到浏览器打开」**不是**「工具没被调用」或「open 接口报错」，而是：
  1. **chrome profile = 扩展中继**：页面会开在「已附加的标签」或通过 CDP 新开的标签；若当时没有任何标签被附加，`ensureTabAvailable` 会抛错，open 会 500，不会成功——故成功即表示当时**已有至少一个附加标签**。
  2. **可见性**：新开的标签可能在**后台**；或已附加的标签在**另一个 Chrome 窗口**。用户需要**切换到该标签或该 Chrome 窗口**才能看到百度。

**「看到浏览器」的前提（汇总）**：

- **chrome profile**（推荐用于「在眼前」）：  
  - 必须先在被控标签上点击 **OpenClaw Browser Relay** 扩展图标（badge 显示 **ON**）。  
  - open 成功后，请**切换到该标签或新打开的标签**（以及该标签所在窗口）查看。
- **openclaw profile**：  
  - 会启动/使用单独的托管 Chrome 窗口，可能在其他桌面或被遮挡；若要把窗口带到前台，需依赖系统/窗口管理，当前实现不保证自动置前。

**可选验证**：  
在**已附加**标签的前提下，再执行一次「用 browser 工具打开 https://www.baidu.com」，然后立刻切到该 Chrome 窗口、该标签，应能看到百度；若仍看不到，再查同一时刻的日志是否有 `browser tool: action=open ... profile=chrome` 与 `tool end`，以确认是同一环境（飞书与 CLI 共用同一 Gateway，故共用同一日志）。

### 4.10 避免「没看到浏览器打开」再次发生（总结与检查清单）

以下为本次问题的根因、已做改动与下次排查的固定步骤，便于用户或助手不再重复同样问题。

**根因一句话**：  
工具已成功调用且 open 已成功时，「没看到」通常是因为：用的是 **chrome 扩展中继**，页面开在「已附加的标签」或「新开的后台标签」——用户需**切换到该标签/窗口**才能看到；若未附加任何标签，open 会报错（500），不会出现“成功但看不见”的情况。

**配置与使用前提（检查清单）**：

| 项目 | 要求 |
|------|------|
| 要「在眼前」看到页面 | `browser.defaultProfile: "chrome"`，且使用 chrome 时不要传 `profile=openclaw` |
| chrome 控制的是哪个标签 | 必须先在被控标签上点击 **OpenClaw Browser Relay** 扩展，badge 为 **ON** |
| open 成功后仍没看到 | 切换到**该已附加标签**或**新打开的标签**及其所在 Chrome 窗口 |

**排查步骤（按日志，不依赖用户自行验证）**：

1. 确认日志文件路径（如 `/tmp/openclaw/openclaw-YYYY-MM-DD.log`）。
2. 执行会触发 browser 的请求（CLI 或飞书发话术）。
3. 在日志中执行：  
   `grep -n -E "browser-tool|browser tool|embedded run tool" /tmp/openclaw/openclaw-*.log | tail -80`
4. 若出现 `browser tool: action=open ... profile=chrome` 且紧接着 `embedded run tool end: ... tool=browser` 无报错 → **工具已成功**；结论是「需用户切换到已附加/新开标签查看」，并提示用户（见下）。
5. 若没有上述 browser-tool 日志 → 本次未调用 browser，需从模型/提示/会话排查（见 4.1、4.8）。

**已做改动（避免再犯）**：

- **配置**：建议/已设 `browser.defaultProfile: "chrome"`；工具在 open/navigate 未传 profile 时使用 defaultProfile。
- **工具描述与系统提示**：明确「要看到页面用 chrome、先 call 工具再根据错误提示让用户附加」。
- **browser 工具 open 成功**：当 profile=chrome 时，返回中附带一句「若用户看不到页面，请其切换到已附加的 Chrome 标签或新打开的标签」，便于 Agent 转述给用户。
- **日志**：browser 工具打 `browser tool: action=... url=... profile=...`（subsystem `agents/browser-tool`），便于 grep 确认是否调用及所用 profile。
- **文档**：本节（4.10）与 4.6、4.9 固定了根因、前提与按日志排查步骤；助手应优先「执行命令 + 看日志」再下结论，而不是只给用户建议让其自行验证。

---

## 五、天气查询回复不完整（wttr.in）关联问题

曾出现过「让我用 wttr.in 查天气」但最终没有返回具体天气的情况，根因是：

- Agent 使用 `exec` 工具执行 `curl wttr.in/...`；
- exec 在默认时间窗内若未结束，只返回「Command still running...」，没有把 stdout 返回给模型。

当前修复方案（已按代码实现）：

- **weather 技能** 已改为优先使用 `web_fetch` 访问 wttr.in：
  - 例如 `https://wttr.in/北京?format=3`；
- 模型拿到完整文本后，再用中文总结返回给用户。

---

## 六、排查命令速查

**「没看到浏览器打开」**：先按 **§4.9、§4.10** 用日志确认是否调用了 browser、profile 与是否成功，再按检查清单确认扩展附加与切换标签。

```bash
# 确认 browser 工具是否被调用（会看到 agents/browser-tool 或 browser tool: action=...）
openclaw logs --follow | grep -E "browser-tool|browser tool|browser|cdp|error"

# 从已有日志文件排查（替换为实际日期）
grep -n -E "browser-tool|browser tool|embedded run tool" /tmp/openclaw/openclaw-*.log | tail -80

# 查看当前浏览器 profile 状态
openclaw browser --browser-profile openclaw status

# 查看最近一次会话 transcript（检查是否有 toolUse）
cat ~/.openclaw/agents/main/sessions/<session-id>.jsonl | python3 -m json.tool | less
```

