# OpenClaw 通道故障诊断与修复记录

> 记录时间: 2026-02-15
> OpenClaw 版本: v2026.2.12

---

## 一、问题现象

### 1.1 Discord

在 Discord 服务器 `openclaw-utm` 的 `#常规` 频道发送 `@openclaw-discard 你好啊`，机器人在线但无任何回复。

### 1.2 飞书

在飞书客户端私聊 `openclaw-feishu` 机器人发送 `你好啊`，机器人无任何回复。

---

## 二、根因分析

### 2.1 Discord 根因: groupPolicy 阻止群组消息

**问题配置:**
```json
{
  "channels": {
    "discord": {
      "groupPolicy": "allowlist"
      // 没有配置 groupAllowFrom，即白名单为空
    }
  }
}
```

**原因:** `groupPolicy: "allowlist"` 要求群组频道 ID 在白名单中才能响应。由于白名单为空，**所有群组消息被静默丢弃**。

**日志证据:** 在用户发消息的时间点 (16:33 UTC)，日志中**没有任何 incoming message 事件**，只有 `chat.history` 请求，说明消息未被处理。

**附加发现 - 网络不稳定:**
日志显示 Discord WebSocket 在 15:39-16:14 UTC 期间反复断连:
```
discord gateway error: Error: Client network socket disconnected before secure TLS connection was established
discord gateway: WebSocket connection closed with code 1006
discord gateway: Attempting resume with backoff: 1000ms → 2000ms → 4000ms → 8000ms → 16000ms → 30000ms
```
最终达到最大重连次数崩溃。重启网关后恢复。这是虚拟机网络环境对 Discord WebSocket 连接不稳定导致。

### 2.2 飞书根因: 事件订阅未配置

**日志证据:**
```
[ws] receive events or callbacks through persistent connection only available in self-build & Feishu app, Configured in:
  Developer Console(开发者后台)
    -> Events and Callbacks(事件与回调)
    -> Mode of event/callback subscription(订阅方式)
    -> Receive events/callbacks through persistent connection(使用 长连接 接收事件/回调)
```

**原因:** OpenClaw 的飞书 WebSocket 客户端已连接成功 (`ws client ready`)，但**飞书服务器不会推送消息事件**，因为飞书开放平台上的应用尚未配置:
1. 事件订阅方式未设为「长连接」
2. 未添加 `im.message.receive_v1` 事件

---

## 三、修复措施

### 3.1 Discord 修复 (已完成)

```bash
# 将群组策略从 allowlist 改为 open
openclaw config set channels.discord.groupPolicy "open"

# 将 DM 策略改为 open
openclaw config set channels.discord.dm.policy "open"
openclaw config set channels.discord.dm.allowFrom '["*"]'

# 重启网关
openclaw gateway restart
```

**修复后验证:**
```
Health:
  Discord  │ OK │ ok (@openclaw-discard:default:1165ms)
```

### 3.2 飞书修复 (需手动操作)

**必须在飞书开放平台手动完成以下 3 步:**

打开: https://open.feishu.cn/app/cli_a91a26d46278dcbd

#### 步骤 1: 配置权限

1. 左侧菜单 → **权限管理**
2. 搜索并开通以下权限:
   - `im:message` (获取与发送单聊、群组消息)
   - `im:message:send_as_bot` (以应用的身份发消息)
   - `im:message.p2p_msg:readonly` (获取用户发给机器人的单聊消息)
   - `im:message:readonly` (读取消息)
   - `im:resource` (获取消息中的资源文件)

或使用**批量开通** (如果有此按钮)，粘贴:
```json
{"scopes":{"tenant":["im:message","im:message:send_as_bot","im:message.p2p_msg:readonly","im:message:readonly","im:resource"]}}
```

#### 步骤 2: 配置事件订阅 (关键!)

1. 左侧菜单 → **事件与回调**
2. 订阅方式选择: **使用长连接接收事件**
3. 点击 **添加事件** → 搜索 `im.message.receive_v1` → 添加
4. **保存**

#### 步骤 3: 创建版本并发布

1. 左侧菜单 → **版本管理与发布**
2. 点击 **创建版本**
3. 填写版本号 `1.0.0`，点击保存
4. 点击 **申请发布**

> 完成后重启网关: `openclaw gateway restart`
> 然后在飞书中重新给机器人发消息测试

---

## 四、修复后配置

```json
{
  "channels": {
    "discord": {
      "enabled": true,
      "token": "MTQ3...M83c",
      "groupPolicy": "open",
      "dm": {
        "policy": "open",
        "allowFrom": ["*"]
      }
    },
    "feishu": {
      "appId": "cli_a91a26d46278dcbd",
      "appSecret": "psPh...FYlH",
      "dmPolicy": "open",
      "groupPolicy": "open"
    }
  }
}
```

---

## 五、安全审计提示

修改为 `open` 策略后，安全审计报告了 3 个 CRITICAL 警告:

| 级别 | 警告 | 说明 |
|------|------|------|
| CRITICAL | Open groupPolicy with elevated tools | groupPolicy="open" 允许任何群组触发机器人 |
| CRITICAL | Discord security warning | 无群组/频道白名单 |
| CRITICAL | Feishu security warning | 任何群成员都可触发 |

**建议:** 测试通过后，将策略改回 `allowlist` 并添加特定群组到白名单:

```bash
# Discord - 恢复安全策略
openclaw config set channels.discord.groupPolicy "allowlist"
# 添加特定频道: openclaw config set channels.discord.groupAllowFrom '["频道ID"]'

# 飞书 - 恢复安全策略
openclaw config set channels.feishu.groupPolicy "allowlist"
# 添加特定群聊: openclaw config set channels.feishu.groupAllowFrom '["oc_xxx"]'
```

---

## 六、验证检查清单

| # | 验证项 | 预期 | 实际 | 状态 |
|---|--------|------|------|------|
| 1 | Discord 深度探测 | OK | ok (@openclaw-discard:default:1165ms) | ✅ |
| 2 | Discord groupPolicy | open | open | ✅ |
| 3 | Discord dm.policy | open | open | ✅ |
| 4 | 飞书深度探测 | OK | ok (default:default:ok) | ✅ |
| 5 | 飞书 dmPolicy | open | open | ✅ |
| 6 | Discord 群组消息回复 | 机器人回复 | **待用户测试** | ⏳ |
| 7 | 飞书私聊回复 | 机器人回复 | **待配置事件订阅** | ⏳ |

---

## 七、快速故障排查命令

```bash
# 查看实时日志（验证消息是否到达网关）
openclaw logs --follow

# 深度状态检测
openclaw status --deep

# 查看完整配置
openclaw config get channels

# 重启网关
openclaw gateway restart

# 飞书配对管理（如果策略改回 pairing）
openclaw pairing list feishu
openclaw pairing approve feishu <CODE>
```

---

> 最后更新: 2026-02-15 00:45
