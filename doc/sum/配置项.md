# OpenClaw 配置项文档

> 配置文件路径: `~/.openclaw/openclaw.json`
> 格式: JSON5 (支持注释)

---

## 一、已配置项

### 1.1 模型配置 (models)

| 配置项 | 当前值 | 说明 |
|--------|--------|------|
| `models.mode` | `"merge"` | 合并模式，保留内置模型定义 |
| `models.providers.dashscope.baseUrl` | `https://dashscope.aliyuncs.com/compatible-mode/v1` | 阿里云 DashScope API 端点 |
| `models.providers.dashscope.apiKey` | `sk-251f...f5e7` | DashScope API Key |
| `models.providers.dashscope.api` | `"openai-completions"` | OpenAI 兼容协议 |
| `models.providers.dashscope.models[0].id` | `"qwen-max"` | 通义千问 Max 模型 (**主力模型**) |
| `models.providers.dashscope.models[1].id` | `"qwen-plus"` | 通义千问 Plus 模型 (备用) |
| 上下文窗口 | `131072` | 128K 上下文窗口 |
| 最大输出 token | `8192` | 单次最大输出 |

> **模型切换说明 (2026-02-16):** 从 `qwen-plus` 升级为 `qwen-max`。原因: `qwen-plus` 在 tool calling（函数调用）方面不稳定，上下文积累后频繁出现只生成描述文本而不实际调用工具的问题。`qwen-max` 的 tool calling 能力显著更强，连续测试 100% 成功率。详见 `doc/sum/飞书浏览器工具调用故障修复.md`。

**配置/修改方法:**
```bash
# 查看当前模型状态
openclaw models list

# 设置默认模型
openclaw config set agents.defaults.model.primary "dashscope/qwen-max"

# 直接编辑配置
openclaw config set models.providers.dashscope.apiKey "新的API Key"
```

### 1.2 Agent 默认配置 (agents)

| 配置项 | 当前值 | 说明 |
|--------|--------|------|
| `agents.defaults.model.primary` | `"dashscope/qwen-max"` | 默认主模型 (已从 qwen-plus 升级) |
| `agents.defaults.compaction.mode` | `"safeguard"` | 上下文压缩模式（安全模式） |
| `agents.defaults.maxConcurrent` | `4` | 最大并发 agent 数 |
| `agents.defaults.subagents.maxConcurrent` | `8` | 最大并发子 agent 数 |

### 1.3 网关配置 (gateway)

| 配置项 | 当前值 | 说明 |
|--------|--------|------|
| `gateway.mode` | `"local"` | 本地模式 |
| 监听地址 | `127.0.0.1:18789` | 仅本地回环 |
| 认证模式 | `token` | Token 认证 |
| Gateway Token | 见 LaunchAgent plist | 自动生成的网关 token |

**配置/修改方法:**
```bash
# 查看网关状态
openclaw gateway status

# 修改端口
openclaw gateway install --port 18790

# 修改绑定模式（局域网可访问）
openclaw gateway install --bind lan
```

### 1.4 通道配置 (channels)

#### 1.4.1 Discord 通道

| 配置项 | 当前值 | 说明 |
|--------|--------|------|
| `channels.discord.enabled` | `true` | Discord 已启用 |
| `channels.discord.token` | `MTQ3...M83c` | Discord Bot Token (openclaw-discard) |
| Discord Bot | `@openclaw-discard` | 机器人名称 |
| Application ID | `1472255888621310093` | Discord 应用 ID |
| `channels.discord.dm.policy` | `"open"` | DM 开放模式（所有人可私聊） |
| `channels.discord.dm.allowFrom` | `["*"]` | 允许所有用户 |
| `channels.discord.groupPolicy` | `"open"` | 群组开放模式（所有频道可触发） |

**状态**: 已连接 (OK)，机器人 `@openclaw-discard` 在线

**邀请链接** (将机器人添加到 Discord 服务器):
```
https://discord.com/oauth2/authorize?client_id=1472255888621310093&scope=bot%20applications.commands&permissions=2147601472
```

**配置/修改方法:**
```bash
# 添加/更新 Discord token
openclaw channels add --channel discord --token "新TOKEN"

# 添加 DM 允许列表用户
openclaw config set channels.discord.dm.allowFrom '["用户ID"]'

# 查看通道状态
openclaw channels status

# 深度检测（含连通性）
openclaw status --deep

# 查看通道日志
openclaw channels logs
```

#### 1.4.2 飞书 (Feishu) 通道

| 配置项 | 当前值 | 说明 |
|--------|--------|------|
| `channels.feishu.enabled` | `true` | 飞书通道已启用 |
| `channels.feishu.appId` | `cli_a91a26d46278dcbd` | 飞书应用 App ID |
| `channels.feishu.appSecret` | `psPh...FYlH` | 飞书应用 App Secret |
| `channels.feishu.domain` | `"feishu"` (默认) | API 域名: feishu(国内) / lark(国际) |
| `channels.feishu.connectionMode` | `"websocket"` (默认) | 连接模式: websocket(长连接) |
| `channels.feishu.dmPolicy` | `"open"` | 私聊开放模式 |
| `channels.feishu.groupPolicy` | `"open"` | 群聊开放模式 |
| `channels.feishu.requireMention` | `true` (默认) | 群聊需要 @机器人 才响应 |
| 应用名称 | `openclaw-feishu` | 飞书应用名称 |
| 飞书开放平台 | https://open.feishu.cn/app/cli_a91a26d46278dcbd | 应用管理页面 |

**状态**: 已连接 (OK)，WebSocket 长连接已建立

**已注册工具**: feishu_doc, feishu_wiki, feishu_drive, feishu_bitable (6 tools)

**配置方法:**
```bash
# 查看当前配置
openclaw config get channels.feishu

# 修改配置
openclaw config set channels.feishu.appId "cli_xxx"
openclaw config set channels.feishu.appSecret "新Secret"
openclaw config set channels.feishu.dmPolicy "open"  # 开放私聊

# 重启网关生效
openclaw gateway restart
```

> 飞书开放平台配置指南请参见: `doc/ref/feishu-bot-setup-guide.md`

### 1.5 Embedding & Memory Search 配置

| 配置项 | 当前值 | 说明 |
|--------|--------|------|
| `agents.defaults.memorySearch.provider` | `"openai"` | 使用 OpenAI 兼容协议 |
| `agents.defaults.memorySearch.model` | `"text-embedding-v4"` | 百炼 Qwen3-Embedding 模型 |
| `agents.defaults.memorySearch.remote.baseUrl` | `https://dashscope.aliyuncs.com/compatible-mode/v1` | DashScope API 端点 |
| `agents.defaults.memorySearch.remote.apiKey` | `sk-251f...f5e7` | DashScope API Key |
| `agents.defaults.memorySearch.fallback` | `"none"` | 无 fallback |
| 向量维度 | 1024 | text-embedding-v4 默认维度 |
| 存储位置 | `~/.openclaw/memory/main.sqlite` | SQLite 向量索引 |

> **配置说明 (2026-02-16):** 配置了百炼 text-embedding-v4 作为 memory search 的 embedding 模型。text-embedding-v4 是 Qwen3-Embedding 系列，支持 64-2048 维向量，默认 1024 维。通过 OpenAI 兼容接口调用 DashScope API。成本: $0.072/百万 token。

**配置/修改方法:**
```bash
# 查看当前配置
openclaw config get agents.defaults.memorySearch

# 修改 embedding 模型
openclaw config set agents.defaults.memorySearch '{"provider":"openai","model":"text-embedding-v4","remote":{"baseUrl":"https://dashscope.aliyuncs.com/compatible-mode/v1","apiKey":"新API_KEY"},"fallback":"none"}'

# 查看索引状态
openclaw memory status

# 重建索引
openclaw memory index --force

# 搜索测试
openclaw memory search "关键词"
```

> 详细 MEMORY 机制说明: `doc/sum/MEMORY机制总结.md`

### 1.6 Memory 后端配置

| 配置项 | 当前值 | 说明 |
|--------|--------|------|
| `memory.backend` | `"builtin"` | 使用内置后端（推荐） |
| `memory.qmd.command` | `/Users/zhanlifeng/.bun/bin/qmd` | QMD CLI 路径（已安装但未启用） |
| `memory.qmd.includeDefaultMemory` | `true` | QMD 索引默认记忆文件 |
| `memory.qmd.searchMode` | `"vsearch"` | QMD 搜索模式 |
| `memory.qmd.scope.default` | `"allow"` | QMD 作用域 |
| `memory.qmd.limits.timeoutMs` | `30000` | QMD 查询超时 |

> **注意:** QMD 后端在当前环境（Apple Paravirtual VM）下因本地模型加载过慢不实用。已测试并保留配置以备切换。详见 `doc/test/Memory后端对比测试.md`。

**切换方法:**
```bash
# 使用 Builtin 后端 (推荐)
openclaw config set memory.backend 'builtin'
openclaw gateway restart

# 切换到 QMD 后端
openclaw config set memory.backend 'qmd'
openclaw gateway restart
```

### 1.7 插件配置 (plugins)

| 配置项 | 当前值 | 说明 |
|--------|--------|------|
| `plugins.entries.discord.enabled` | `true` | Discord 插件已启用 |
| `plugins.entries.feishu.enabled` | `true` | 飞书插件已启用 |

**配置/修改方法:**
```bash
# 列出所有插件
openclaw plugins list

# 启用插件
openclaw plugins enable <plugin-id>

# 禁用插件
openclaw plugins disable <plugin-id>
```

### 1.8 浏览器配置 (browser)

| 配置项 | 当前值 | 说明 |
|--------|--------|------|
| `browser.enabled` | `true` | 已启用 |
| `browser.defaultProfile` | `"openclaw"` | 默认托管模式（专用 Chrome 实例） |
| `browser.executablePath` | `/Applications/Google Chrome.app/.../Google Chrome` | Chrome 可执行路径 |
| CDP 端口 | 18800 (openclaw profile) | 托管浏览器 CDP 端口 |

**Profile 说明:**
- `openclaw`: 托管浏览器，无需扩展
- `chrome`: 扩展中继，需安装 OpenClaw Chrome 扩展

**快速操作:**
```bash
openclaw browser --browser-profile openclaw start
openclaw browser --browser-profile openclaw open https://example.com
openclaw browser --browser-profile openclaw snapshot
```

> 详细操作手册: `doc/operate/浏览器控制操作手册.md`
> 功能总结: `doc/sum/浏览器控制功能总结.md`

### 1.9 消息配置 (messages)

| 配置项 | 当前值 | 说明 |
|--------|--------|------|
| `messages.ackReactionScope` | `"group-mentions"` | 群组中仅对 @提及 的消息做已读反应 |

### 1.10 命令配置 (commands)

| 配置项 | 当前值 | 说明 |
|--------|--------|------|
| `commands.native` | `"auto"` | 自动检测原生命令 |
| `commands.nativeSkills` | `"auto"` | 自动检测原生技能命令 |

---

## 二、待配置项（可选扩展）

### 2.1 更多通道

| 通道 | 插件 ID | 配置命令 | 用途 |
|------|---------|----------|------|
| Telegram | `telegram` | `openclaw plugins enable telegram && openclaw channels add --channel telegram --token "BOT_TOKEN"` | Telegram 机器人 |
| WhatsApp | `whatsapp` | `openclaw plugins enable whatsapp && openclaw channels login` | WhatsApp Web 链接（QR扫码） |
| Slack | `slack` | `openclaw plugins enable slack && openclaw channels add --channel slack --bot-token "xoxb-..." --app-token "xapp-..."` | Slack 集成 |
| 飞书 | `feishu` | **已配置** — App ID: `cli_a91a26d46278dcbd` | 飞书/Lark 机器人 |
| iMessage | `imessage` | `openclaw plugins enable imessage` | macOS iMessage |
| Signal | `signal` | `openclaw plugins enable signal` | Signal 隐私通信 |
| Matrix | `matrix` | `openclaw plugins enable matrix` | 去中心化通信 |

### 2.2 更多模型提供商

| 提供商 | 配置方式 | 说明 |
|--------|----------|------|
| Anthropic Claude | `openclaw models auth paste-token --provider anthropic` 后输入 key | Claude 系列模型 |
| OpenAI | `openclaw models auth paste-token --provider openai` 后输入 key | GPT 系列模型 |
| GitHub Copilot | `openclaw models auth login-github-copilot` | GitHub 设备流登录 |
| Google Gemini | `openclaw plugins enable google-gemini-cli-auth` | Gemini 模型 |
| 本地模型 | 配置 `node-llama-cpp`，添加 `providers.local` | 本地 LLM 推理 |

**添加新模型提供商到配置:**
```bash
# 方式一: CLI 交互式添加
openclaw models auth add

# 方式二: 粘贴 token
openclaw models auth paste-token --provider anthropic
# 然后输入 API key

# 方式三: 直接编辑配置（以 OpenAI 为例）
# 在 ~/.openclaw/openclaw.json 的 models.providers 中添加:
# "openai": {
#   "baseUrl": "https://api.openai.com/v1",
#   "apiKey": "sk-...",
#   "api": "openai-completions"
# }

# 设置模型回退列表
openclaw models fallbacks set dashscope/qwen-plus openai/gpt-4o
```

### 2.3 安全配置

| 配置项 | 路径 | 用途 | 配置方法 |
|--------|------|------|----------|
| DM 允许列表 | `channels.discord.dm.allowlist` | 控制谁可以私信 | `openclaw config set channels.discord.dm.allowlist '["用户ID"]'` |
| 沙盒模式 | `agents.defaults.sandbox` | Agent 工具隔离执行 | 需安装 Docker，参见 2.5 |
| 执行审批 | `agents.defaults.execApprovals` | 敏感命令需确认 | `openclaw approvals --help` |

### 2.4 高级网关配置

| 配置项 | 路径 | 用途 | 配置方法 |
|--------|------|------|----------|
| 自定义端口 | `gateway.port` | 修改监听端口 | `openclaw gateway install --port <port>` |
| LAN 绑定 | `gateway.bind` | 局域网可访问 | `openclaw gateway install --bind lan` |
| Tailscale 暴露 | `gateway.tailscale` | 通过 VPN 远程访问 | `openclaw gateway --tailscale serve` |
| TLS | `gateway.tls` | HTTPS 加密 | 配置 `gateway.tls.cert` 和 `gateway.tls.key` |

### 2.5 Docker 沙盒配置

```bash
# 安装 Docker Desktop (如果未安装)
# 构建沙盒镜像
cd ~/Documents/workspace/openclaw/openclaw-src
./scripts/sandbox-setup.sh

# 在配置中启用沙盒:
# "agents.defaults.sandbox.mode": "non-main"
# "agents.defaults.sandbox.scope": "agent"
```

### 2.6 定时任务 (Cron)

```bash
# 查看 cron 帮助
openclaw cron --help

# 通过对话设置: 对 Bot 说 "每天早上9点给我发天气预报"
```

### 2.7 Webhook

```bash
# 查看 webhook 帮助
openclaw webhooks --help

# 创建 webhook 用于外部系统触发
```

---

## 三、环境变量

| 变量 | 用途 | 默认值 |
|------|------|--------|
| `OPENCLAW_HOME` | 主目录 | `~` |
| `OPENCLAW_STATE_DIR` | 状态数据目录 | `~/.openclaw` |
| `OPENCLAW_CONFIG_PATH` | 配置文件路径 | `~/.openclaw/openclaw.json` |
| `OPENCLAW_GATEWAY_TOKEN` | 网关认证 Token | LaunchAgent 中设置 |
| `OPENCLAW_GATEWAY_PORT` | 网关端口 | `18789` |
| `SHARP_IGNORE_GLOBAL_LIBVIPS` | 忽略系统 libvips | `1`（推荐） |

---

## 四、配置文件完整结构参考

```json5
{
  // 环境变量（支持 ${VAR} 引用）
  "env": { "vars": {} },

  // 模型配置
  "models": {
    "mode": "merge",           // merge | replace
    "providers": { /* ... */ }
  },

  // Agent 配置
  "agents": {
    "defaults": {
      "model": { "primary": "provider/model" },
      "compaction": { "mode": "safeguard" },  // off | safeguard | aggressive
      "sandbox": { "mode": "off" },           // off | non-main | all
      "maxConcurrent": 4
    }
  },

  // 网关配置
  "gateway": {
    "mode": "local",           // local | remote
    "bind": "loopback",       // loopback | lan | tailnet | auto | custom
    "port": 18789
  },

  // 通道配置
  "channels": { /* ... */ },

  // 插件配置
  "plugins": { "entries": {} },

  // 消息配置
  "messages": { "ackReactionScope": "group-mentions" },

  // 工具配置
  "tools": { /* ... */ },

  // 技能配置
  "skills": { /* ... */ }
}
```
